-- this function is hooked before resolving starts
function preresolve_mf(dq)
	-- check blocklist
	if filterdomains:check(dq.qname) or filterips:check(dq.remoteaddr) or filtercidr:match(dq.remoteaddr) then
		if dq.qtype == pdns.A or dq.qtype == pdns.ANY then
			dq:addAnswer(pdns.A, "127.0.0.1")
		end
		
		if dq.qtype == pdns.AAAA or dq.qtype == pdns.ANY then
			dq:addAnswer(pdns.AAAA, "::1")
		end
		
		filterlist_metric:inc()
		return true
	end

	-- default, do not rewrite this response
	return false
end

-- List of malware ips
filterips=newCAS()
loadFile("/etc/powerdns/filter-ips.list", filterips)

-- List of malware cidr
filtercidr=newNMG()
loadFileNMG("/etc/powerdns/filter-cidr.list", filtercidr)

-- List of malware domains
filterdomains=newDS()
loadFile("/etc/powerdns/filter-domains.list", filterdomains)

-- get metrics
filterlist_metric = getMetric("filterlist_hits")